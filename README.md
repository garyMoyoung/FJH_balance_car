# 平衡小车项目说明文档

## 项目简介

本项目为基于 STM32F103C8T6 单片机的平衡小车控制系统，支持 MPU6050 姿态传感器、遥控控制、视觉跟踪（K230）、OLED 显示、遥控板控制等功能。项目采用多种通信协议实现数据交互，并通过 PID 控制实现小车的平衡与运动。

---

## 目录结构

```
BALANCE_CAR_TEST_4.1/
├── User/
│   ├── main.c                // 主程序入口
│   ├── stm32f10x_conf.h
│   ├── stm32f10x_it.c
│   ├── stm32f10x_it.h
├── Hardware/
│   ├── Key.c/h               // 按键驱动
│   ├── LED.c/h               // LED驱动
│   ├── OLED.c/h              // OLED显示驱动（软IIC）
│   ├── oled_hard_iic.c/h     // OLED显示驱动（硬件IIC）
│   ├── OLED_Font.h           // OLED字库
│   ├── pid.c/h               // PID控制器
│   ├── timer.c/h             // 定时器相关
│   ├── usart_car.c/h         // 串口通信
│   ├── yb_protocol.c/h       // 通信协议解析
├── MPU6050DMP/
│   ├── MPU6050.c/h           // 姿态传感器驱动
│   ├── MPU6050_I2C.c/h
│   ├── inv_mpu.c/h           // DMP算法相关
│   ├── inv_mpu_dmp_motion_driver.c/h
│   ├── dmpKey.h
│   ├── dmpmap.h
```

---

## 主要功能

- **平衡控制**：通过 MPU6050 获取姿态数据，PID 控制电机实现自平衡。
- **视觉跟踪**：通过串口接收 K230 视觉数据，实现小球跟踪与距离控制。
- **遥控板控制**：支持遥控板数据接收，控制小车运动状态。
- **OLED显示**：实时显示传感器数据、运动状态等信息。
- **多协议通信**：支持自定义二进制协议和字符串协议，兼容上位机串口助手。

---

## 通信协议说明

### 1. 视觉协议（字符串帧）

- 格式：`$len,id,x,y,w,h#`
- 示例：`$20,1,594,456,123,90#`
- 说明：`$`为帧头，`#`为帧尾，逗号分隔各字段，所有数据为字符串形式。

### 2. 遥控板/上位机协议（二进制帧）

- 格式：`FE EF [xH][xL][yH][yL][wH][wL][hH][hL] 21 22`
- 示例：`FE EF 00 00 01 0C 02 26 00 AB 21 22`
- 说明：`FE EF`为帧头，`21 22`为帧尾，中间8字节依次为x、y、w、h（高字节在前）。

---

## 编译与下载

1. 使用 Keil 或 STM32CubeIDE 打开工程。
2. 选择目标芯片 STM32F103C8T6。
3. 编译并下载程序到开发板。

---

## 使用说明

- **上位机串口助手**：
  - 视觉协议：文本模式发送如 `$20,1,594,456,123,90#`
  - 二进制协议：HEX模式发送如 `FE EF 00 00 01 0C 02 26 00 AB 21 22`
- **硬件连接**：
  - MPU6050 接 I2C1（PB8/PB9，需重映射并加上拉电阻）
  - OLED 接 I2C1 或软IIC（PB8/PB9 或 PB6/PB7）
  - 电机驱动板接 GPIO 及 PWM
  - 超声波模块接 GPIOA
  - 使用stm32标准库编写
---

## 关键文件说明

- `main.c`：主循环与中断服务，包含运动逻辑、数据解析、PID控制等。
- `yb_protocol.c/h`：视觉协议解析与数据缓存。
- `usart_car.c/h`：串口初始化与数据收发。
- `pid.c/h`：PID控制器实现。
- `oled_hard_iic.c/h`：OLED硬件IIC驱动。
- `MPU6050.c/h`：姿态传感器驱动与数据获取。

---

## 联系与反馈

如有问题或建议，请联系项目负责人或在代码仓库提交 Issue。
